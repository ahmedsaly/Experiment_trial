<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thesis Experiment</title>

   <!-- jsPsych and Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" />
  <script src="https://unpkg.com/jspsych@8.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.4"></script>

  <!-- Three.js & Panolens -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r105/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/panolens@0.12.0/build/panolens.min.js"></script>

  <!-- Experiment Styles -->
  <style>
    /* ----------------------
       Global Variables
    ---------------------- */
    :root {
      --color-primary: #007bff;
      --color-success: #28a745;
      --color-error:  #dc3545;
      --overlay-bg:   rgba(255, 255, 255, 0.9);
      --text-color: rgba(255, 255, 255, 0.9);
      --blur-effect: blur(2px);
    }
    
    /* ----------------------
       Base Styles
    ---------------------- */
    body {
      font-family: sans-serif;
      overflow: hidden;
      /* background: black; */
      height: 100vh;
      margin: 0;
    }

    #jspsych-target {
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      margin: 0;
    }

    .black-background {
      background: black !important;
    }

    /* ----------------------
       Welcome Screen
    ---------------------- */
    .welcome-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: calc(14px + 0.5vw);
    }
    
    /* ----------------------
       Panorama View
    ---------------------- */
    #panorama {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      cursor: grab;
      z-index: 1; 
    }
    #panorama:active {
      cursor: grabbing;
    }

    /* ----------------------
       Money Display Section
    ---------------------- */
    .money-container {
      position: absolute;
      right: 2vw;
      top: 2vh;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    .money-display {
      position:static;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 1vh 1.5vw;
      border-radius: 5px;
      text-align: left;
      font-size: calc(12px + 0.3vw);
      backdrop-filter: var(--blur-effect);
      display: flex;
      flex-direction: column;
    }

    .money-item {
      margin: 0.5vh 0;
    }

    .money-label {
      font-weight: normal;
      color: var(--text-color);
    }

    .money-value {
      font-weight: bold;
      color: var(--color-success);
    }

    .bonus-value {
      color: var(--text-color);
      display: inline-block;
      position: relative;
    }

    /* Bonus Animation */
    @keyframes bonusPop {
      0% { transform: scale(1); color: var(--text-color); }
      40%, 60% { transform: scale(1.5); color: var(--color-error); }
      100% { transform: scale(1); color: var(--text-color); }
    }

    .bonus-value.animate {
      animation: bonusPop 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    /* ----------------------
       Navigation Buttons
    ---------------------- */
    .next-view-btn {
      position: static;
      padding: 10px 20px;
      background-color: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 4px;
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 1000;
      backdrop-filter: var(--blur-effect);
      width: fit-content;
    }

    .next-view-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background-color: rgba(255, 255, 255, 0.05);
    }

    .next-view-btn.complete {
      background-color: rgba(40, 167, 69, 0.2);
      color: var(--text-color);
    }

    .next-view-btn.complete:not(:disabled):hover {
      background-color: rgba(40, 167, 69, 0.3);
      transform: scale(1.05);
    }
    
    /* ----------------------
      Bottom UI Components
    ---------------------- */

    /* Hover Trigger - Bottom bar that reveals options panel */
    .hover-trigger {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 20%;
      height: 3%;
      background: rgba(255, 255, 255, 0.2);
      z-index: 1001;
      cursor: pointer;
      border-radius: 4px;

      /* Center contents */
      display: flex;
      align-items: center;
      justify-content: center;
      
      /* Smooth transitions */
      /* transition: all 0.2s ease-in-out; */
    }

    /* Upward-pointing triangle indicator */
    .hover-trigger::before {
      content: '';
      position: absolute;
      top: 8px;

      /* Triangle shape */
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid rgba(255, 255, 255, 0.8);
    
      /* transition: all 0.2s ease-in-out; */
    }

    /* Bottom line indicator */
    .hover-trigger::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 2px;
      background: rgba(255, 255, 255, 0.5);
      /* transition: all 0.2s ease-in-out; */
    }

    /* Hover state */
    .hover-trigger:hover {
      /* height: 3%; */
      background: rgba(255, 255, 255, 0.3);
      /* width: 20%; */
    }

    .hover-trigger:hover::before {
      border-bottom-color: rgba(255, 255, 255, 1);
      top: 10px;
    }

    .hover-trigger:hover::after {
      /* height: 2px; */
      background: rgba(255, 255, 255, 0.8);
    }

    /* Hidden state */
    .hover-trigger.hidden {
      opacity: 0;
      pointer-events: none;
      cursor: default;
      transition: opacity 0s ease-in-out;
    }

    /* ----------------------
      Bottom Panel Section
    ---------------------- */

    /* Bottom section container */
    .bottom-section {
      position: fixed;
      display: none;
      bottom: -100%;
      left: 0;
      width: 100%;
      z-index: 1000;
      
      /* Styling */
      background-color: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 10px 10px 0 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);

      /* Animation */
      transition: bottom 0.3s ease-in-out;
    }

    /* Visible state */
    .bottom-section.visible {
      display: block;
      bottom: 0;
    }

    .hover-trigger:hover ~ .bottom-section {
      transition: bottom 0.3s ease-in-out;
      display: block;
      bottom: 0;
    }

    /* .bottom-section:hover {
      display: block;
    } */
    
    /* Fixed bottom section after choice confirmation */
    .bottom-section.fixed {
      bottom: 0;
      display: block;
      transition: none;
    }

    .bottom-section.fixed ~ .hover-trigger {
      display: none;
    }

    /* ----------------------
       Buttons & Messages
       ---------------------- */

    /* Button styles */
    button {
      display: inline-block;
      padding: 0.5vh 2vw;
      /* font-size: calc(12px + 0.3vw); */
      font-size: clamp(14px, 2vmin, 16px);
      width: auto;
      min-width: min-content;
      margin: 0 auto;
    }
    
    /* Submit button margin */
    #submitBtn, #confirmBtn, #nextLayoutBtn {
      margin-bottom: 20px;
      white-space: nowrap;
      padding: 0.5vh 2vw;
    }

    .confirm-btn, #nextLayoutBtn {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .confirm-btn:hover, #nextLayoutBtn:hover {
      background-color: #218838;
    }

    .confirm-btn:disabled, #nextLayoutBtn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    #submitBtn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* ----------------------
      Layout Container
    ---------------------- */

    /* Layout container adjustments */
    #layout-container {
      /* position: static; */
      width: 100%;
      /* max-width: 800px; */
      margin: 0 auto;
    }

    #layout-container p {
      margin: 1vh 0;
      font-size: calc(12px + 0.3vw);
    }

    /* Layout Options Grid */
    .layout-options-container {
      display: flex;
      gap: 1.5vw;
      justify-content: center;
      padding: 1vh 0;
      /* min-width: 80%; */
    }

    /* Layout option container */
    .layout-option {
      position: relative;
      margin: 0 1vw;
    }

    /* Layout Images */
    .layout-img {
      width: 40vmin; /* Responsive size based on viewport */
      /* min-width: 200px; */
      height: auto;
      border: 2px solid transparent;
    }

    .layout-img:hover { border-color: blue; }
    .layout-img.selected { border-color: green; }
    .layout-img.selected:hover {border: 2px solid green;}
    .layout-img.correct { border: 3px solid var(--color-success) !important; }
    .layout-img.incorrect { border: 3px solid var(--color-error) !important; }

    /* Layout labels */
    .layout-label {
      position: absolute;
      bottom: -3vh;
      left: 50%;
      transform: translateX(-50%);
      font-size: calc(14px + 0.2vw);
      font-weight: bold;
      color: #333;
    }
    
    .message-success {
      background-color: #dff0d8;
      color: #3c763d;
      border: 1px solid #d6e9c6;
    }

    .message-error {
      background-color: #f2dede;
      color: #a94442;
      border: 1px solid #ebccd1;
    }

    /* Potential bonus message */
    .potential-bonus-message {
      padding: 10px;
      background-color: rgba(0, 123, 255, 0.1);
      border-radius: 5px;
      text-align: center;
      font-size: clamp(12px, 1.8vmin, 14px);
      color: #007bff;
      width: 70%;
      align-self: center;
      justify-content: center;
      margin: 2vh auto 0 auto;
    }

    .bonus-amount {
      font-weight: bold;
      font-size: clamp(12px, 1.8vmin, 16px)
    }

    .feedback-text {
      text-align: center;
      /* font-size: calc(14px + 0.3vw); */
      font-weight: bold;
      /* margin: 30px 0 1vh 0; */
      font-size: clamp(12px, 2vmin, 16px);
      margin: 1vh 0;
    }

    .feedback-correct {
      color: #28a745;
    }

    .feedback-incorrect {
      color: #dc3545;
    }

    /* ----------------------
       Confidence Scale
       ---------------------- */
    /* Confidence scale container */
    .confidence-container {
      margin: 0px 0;
      width: 80%;
      padding: 10px;
      border-radius: 8px;
      margin:auto;
    }

    /* Shake animation for required field */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-3px); }
      40%, 80% { transform: translateX(3px); }
    }

    .confidence-container.shake {
      animation: shake 0.8s ease-in-out;
      border: 2px solid #dc3545;  /* Red border during shake */
    }

    .confidence-options {
      display: flex;
      justify-content: center;
      /* flex-wrap: nowrap; */
      gap: 1vw;
      align-items: center;
      padding: 0 1vw;
    }

    .confidence-option {
      flex: 1;
      min-width: max-content; /* Prevent text truncation */
      display: flex;
      align-items: center;
      /* gap: 8px; */
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .confidence-option:hover {
      background-color: rgba(0, 123, 255, 0.1);
    }

    .confidence-option.selected {
      background-color: rgba(0, 123, 255, 0.2);
    }

    .check-circle {
      width: 20px;
      height: 20px;
      border: 2px solid #007bff;
      border-radius: 50%;
      position: relative;
      transition: all 0.2s ease;
    }

    .confidence-option.selected .check-circle {
      background-color: #007bff;
    }

    .confidence-option.selected .check-circle::after {
      content: '✓';
      position: absolute;
      color: white;
      font-size: clamp(9px, 1.5vmin, 14px);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .option-text {
      /* font-size: 14px; */
      font-size: clamp(10px, 1.5vmin, 14px); /* Responsive text */
      color: #333;
      /* white-space: nowrap; */
    }

  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <script>
    let viewIndex = 0;
    let viewCost = 0.30;
    let baseMoney = 1.00;
    let maxBonus = 4.00;
    let viewsTaken = 0;
    let viewStartTime = 0;
    let viewDurations = [];
    let layoutData = [];
    let layoutStartTime = 0;
    let progressStartTime = 0; // Add this to track when each view starts
    let progressCompletionTimes = []; // Add this to store completion times for each view
    let logData = [];
    let currentArea = null;
    let areaStartTime = null;
    let lastSection = null;
    let currentActionDetails = [];

    const getTimestamp = () => new Date().toISOString();

    // Function to update money display
    const updateMoneyDisplay = () => {
      const currentBonus = (maxBonus - viewsTaken * viewCost).toFixed(2);
      const moneyDisplay = document.querySelector('.money-display');
      const previousBonus = moneyDisplay.querySelector('.bonus-value')?.textContent.replace('+€', '');
      
      // Create new bonus value element
      const bonusValue = document.createElement('span');
      bonusValue.className = 'money-value bonus-value';
      bonusValue.textContent = `+€${currentBonus}`;
      
      // Add animation class if bonus decreased
      if (previousBonus && parseFloat(currentBonus) < parseFloat(previousBonus)) {
        bonusValue.classList.add('animate');
      }
      
      moneyDisplay.innerHTML = `
        <div class="money-item">
          <span class="money-label">Earned Money: &nbsp;</span>
          <span class="money-value">€${totalEarned.toFixed(2)}</span>
        </div>
        <div class="money-item">
          <span class="money-label">Potential Bonus: </span>
        </div>
      `;
      
      // Append the bonus value element
      moneyDisplay.querySelector('.money-item:last-child').appendChild(bonusValue);
      
      // Remove animation class after animation completes
      bonusValue.addEventListener('animationend', () => {
        bonusValue.classList.remove('animate');
      });
    };

    /* initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function() {
        // jsPsych.data.displayData();
      },
      on_data_update: function(data) {
        data.subject_id = subject_id;  // Add subject ID to all trials
      }
    });

    // Generate a unique subject ID and filename (add this right after jsPsych initialization)
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;

    /* create timeline */
    var timeline = [];

    // var preload = {
    //   type: jsPsychPreload,
    //   images: ["panorama/panorama3.png", "panorama/Equirectangular3.png"]
    // };
    // timeline.push(preload);

    /* define welcome message trial */
    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<div class="welcome-message">Welcome to the experiment. Press any key to begin.</div>`,
      data: {
        name: "Welcome message"
      }
    };
    timeline.push(welcome);

    const renderPanorama = (image, container) => {
      container.innerHTML = ""; // clear old pano
      const pano = new PANOLENS.ImagePanorama(image);
      const viewer = new PANOLENS.Viewer({ 
        container, 
        controlButtons: [],
        screenSpacePanning : false,    // no weird XY drift
        dampingFactor : 100,      // adjust inertia/smoothing
        enableDamping : true,      // adds smoothness
        output: 'stereo'  // Enable stereo rendering for better fullscreen experience
      });
      viewer.add(pano);

      progressStartTime = Date.now(); // Reset progress start time for new view

      // In the renderPanorama function, modify the onResize handler:
      const TARGET_HFOV = 90; // Horizontal FOV in degrees
      const TARGET_VFOV = 60; // Vertical FOV in degrees

      function onResize() {
        const container = document.getElementById('panorama');
        const windowRatio = window.innerWidth / window.innerHeight;
        const targetAspect = Math.tan((TARGET_HFOV * Math.PI/180)/2) / Math.tan((TARGET_VFOV * Math.PI/180)/2);

        // Adjust container dimensions
        if (windowRatio > targetAspect) {
          container.style.height = '100vh';
          container.style.width = `${100 * targetAspect * (window.innerHeight/window.innerWidth)}vw`;
        } 
        else {
          container.style.width = '100vw';
          container.style.height = `${100 / targetAspect * (window.innerWidth/window.innerHeight)}vh`;
        }

        // Update camera
        const camera = viewer.getCamera();
        camera.fov = TARGET_VFOV;
        camera.aspect = targetAspect;
        camera.updateProjectionMatrix();
        viewer.renderer.setSize(container.clientWidth, container.clientHeight);
      }

      window.addEventListener('resize', onResize);
      onResize();  // run once to initialize

      // How far you can orbit vertically, upper and lower limits.
      // Range is 0 to Math.PI radians.
      // 0 = looking straight up, Math.PI = looking straight down
      viewer.OrbitControls.minPolarAngle = Math.PI * 0.2;  // Allow looking up slightly
      viewer.OrbitControls.maxPolarAngle = Math.PI * 0.7;  // Allow looking down slightly

      viewer.OrbitControls.rotateSpeed = -0.2;         // mouse drag sensitivity
      viewer.OrbitControls.minDistance = 0;           // disable zoom
      viewer.OrbitControls.maxDistance = 1;

      // Prevent mouse wheel from doing anything in the panorama
      container.addEventListener('wheel', (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, { passive: false });

      // Initialize viewing tracking - create new Set for each panorama
      const viewedAngles = new Set();
      const angleThreshold = 90; // Split the 360° view into 6 sections
      const requiredSections = 4; // Require viewing at least 6 out of 6 sections
      let hasRecordedCompletionTime = false; // Add this flag
      
      // Disable Next View button and Submit button initially
      document.getElementById('nextViewBtn').disabled = true;
      document.getElementById('nextViewBtn').title = "Please view the whole scene to proceed";
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      const feedbackDiv = document.querySelector(".feedback-text");
      if (feedbackDiv) {
        feedbackDiv.textContent = "Please view the whole scene first.";
        feedbackDiv.className = "feedback-text feedback-incorrect";
      }

      // Create circular progress indicator
      const progressCircle = document.createElement('div');
      progressCircle.style.position = 'absolute';
      progressCircle.style.bottom = '20px';
      progressCircle.style.left = '20px';  // Changed from right to left
      progressCircle.style.width = '60px';
      progressCircle.style.height = '60px';
      progressCircle.style.backgroundColor = 'rgba(0,0,0,0.7)';
      progressCircle.style.borderRadius = '50%';
      progressCircle.style.padding = '5px';
      container.appendChild(progressCircle);

      // Create sections
      for (let i = 0; i < 4; i++) {
        const section = document.createElement('div');
        section.className = `section-${i}`;
        section.style.position = 'absolute';
        section.style.width = '100%';
        section.style.height = '100%';
        section.style.left = '0%';
        section.style.top = '0';
        section.style.transformOrigin = '50% 50%';
        section.style.transform = `rotate(${-i * 90}deg)`;
        section.style.clipPath = 'polygon(0 0, 100% 0, 50% 50%)';
        section.style.backgroundColor = 'rgba(255,255,255,0.2)';
        section.style.transition = 'background-color 0.3s';
        progressCircle.appendChild(section);
      }

      // Add center dot
      const centerDot = document.createElement('div');
      centerDot.style.position = 'absolute';
      centerDot.style.width = '10px';
      centerDot.style.height = '10px';
      centerDot.style.backgroundColor = 'white';
      centerDot.style.borderRadius = '50%';
      centerDot.style.left = '50%';
      centerDot.style.top = '50%';
      centerDot.style.transform = 'translate(-50%, -50%)';
      progressCircle.appendChild(centerDot);

      // Update sections based on viewed angles
      const updateSections = () => {
        viewedAngles.forEach(section => {
          const sectionElement = progressCircle.querySelector(`.section-${section}`);
          if (sectionElement) {
            sectionElement.style.backgroundColor = 'rgba(40,167,69,0.8)'; // Green color
          }
        });

        // Enable Next View button and Submit button, update arrow color if enough sections have been viewed
        if (viewedAngles.size >= requiredSections) {
          // Record completion time when progress circle is complete, but only once per view
          if (!hasRecordedCompletionTime) {
            const completionTime = (Date.now() - progressStartTime) / 1000; // Convert to seconds
            progressCompletionTimes.push(completionTime);
            hasRecordedCompletionTime = true;
          }

          document.getElementById('nextViewBtn').disabled = false;
          document.getElementById('nextViewBtn').title = "You can now proceed to the next view";
          progressCircle.style.boxShadow = '0 0 10px rgba(40,167,69,0.8)'; // Add glow effect when complete
          document.getElementById('nextViewBtn').classList.add('complete');

          // Enable Submit button and clear message
          submitBtn.disabled = false;
          if (feedbackDiv) {
            feedbackDiv.textContent = "";
            feedbackDiv.className = "feedback-text";
          }
        } 
        else {
          // Disable Submit button and show message
          submitBtn.disabled = true;
          if (feedbackDiv) {
            feedbackDiv.textContent = "Please view the whole scene first.";
            feedbackDiv.className = "feedback-text feedback-incorrect";
          }
        }
      };

      // Track camera movement using OrbitControls change event
      const changeHandler = () => {
        const camera = viewer.getCamera();
        const longitude = ((camera.rotation.y * (180/Math.PI)) + 360) % 360;
        const currentSection = Math.floor((longitude + 360) % 360 / 90) % 4;

        if (currentSection !== lastSection) {
          logAreaChange(`section${currentSection + 1}`);
          lastSection = currentSection;
        }

        const section = Math.floor(longitude / angleThreshold);
        viewedAngles.add(section);
        updateSections();
      };

      // Add the event listener
      viewer.OrbitControls.addEventListener('change', changeHandler);

      // Clean up function to remove event listeners when switching panoramas
      const cleanup = () => {
        viewer.OrbitControls.removeEventListener('change', changeHandler);
        viewer.dispose();
        // Reset the right hover trigger
        document.getElementById('nextViewBtn').classList.remove('complete');
        document.getElementById('nextViewBtn').disabled = true;
        document.getElementById('nextViewBtn').title = "Please view the whole scene to proceed";
        hasRecordedCompletionTime = false; // Reset the flag when cleaning up
      };

      // Store cleanup function on the container for later use
      container.cleanup = cleanup;
    };
    
    const layouts = [
      {
        panoramas: ["panorama/panorama3.png", "panorama/Equirectangular3.png"],
        options: ["Layout_options/layout1.png", "Layout_options/layout2.png", "Layout_options/layout4.png"],
        correctAnswer: "B",
        maxBonus: 4.00
      },
      // Add more layouts here with their respective panoramas, options, and correct answers
      {
        panoramas: ["panorama/panorama2.png", "panorama/panorama3.png"],
        options: ["Layout_options/layout3.png", "Layout_options/layout5.png", "Layout_options/layout2.png"],
        correctAnswer: "A",
        maxBonus: 4.00
      },
      {
        panoramas: ["panorama/panorama3.png", "panorama/Equirectangular3.png"],
        options: ["Layout_options/layout1.png", "Layout_options/layout2.png", "Layout_options/layout4.png"],
        correctAnswer: "B",
        maxBonus: 4.00
      }
    ];

    let currentLayoutIndex = 0;
    let totalEarned = baseMoney;

    const trial_combined = {
      type: jsPsychHtmlButtonResponse,
      data: {
        name: "Experiment"
      },
      stimulus: `
        <div style="height: 100vh; display: flex; flex-direction: column; gap: 1vh;">
          <div class="money-container">
            <div class="money-display"></div>
            <button id="nextViewBtn" class="next-view-btn" disabled title="Please view the whole scene to proceed">
              Next View
            </button>
          </div>
          <div id="panorama"></div>
          <div class="hover-trigger"></div>
          <div class="bottom-section">
            <div id="layout-container">
              <p>Select the layout you think is correct:</p>
              <div class="layout-options-container">
                <!-- Layout options will be inserted here dynamically -->
              </div>
            </div>
            <div class="potential-bonus-message">
              If you choose the correct answer, you will earn an extra bonus of €<span class="bonus-amount">${(maxBonus - viewsTaken * viewCost).toFixed(2)}</span>
            </div>
            <div class="feedback-text"></div>
            <div id="message" class="message-container"></div>
            <button id="submitBtn">Submit Choice</button>
            <button id="nextLayoutBtn" style="display: none;">Next Layout</button>
          </div>
        </div>
      `,
      choices: [], // No choices - we'll use our custom buttons
      
      on_load: function() {
        logAreaChange(`layout-${currentLayoutIndex + 1}-start`); 
        // Add black background to body when trial starts
        document.body.classList.add('black-background');

        // Initialize layout start time when the trial loads
        layoutStartTime = getTimestamp();
        // Initialize view start time when the trial loads
        viewStartTime = Date.now();
        
        // Initialize money display
        updateMoneyDisplay();

        // Add event listeners for bottom section and hover trigger interaction
        const bottomSection = document.querySelector('.bottom-section');
        const hoverTrigger = document.querySelector('.hover-trigger');

        bottomSection.addEventListener('mouseenter', () => {
          hoverTrigger.classList.add('hidden');
          logAreaChange('bottom-section');
        });

        bottomSection.addEventListener('mouseleave', () => {
          hoverTrigger.classList.remove('hidden');
          logAreaChange(null); // Will log exit from bottom-section
        });

        document.addEventListener('mousemove', (e) => {
          const hoverTriggerRect = hoverTrigger.getBoundingClientRect();
          const isHovering = e.clientY >= hoverTriggerRect.top && 
                            e.clientX >= hoverTriggerRect.left && 
                            e.clientX <= hoverTriggerRect.right;

          if (isHovering || bottomSection.matches(':hover')) {
            bottomSection.classList.add('visible');
            hoverTrigger.classList.add('hidden');
          } else {
            bottomSection.classList.remove('visible');
            hoverTrigger.classList.remove('hidden');
          }
        })

        // Add touch event listeners for mobile devices
        bottomSection.addEventListener('touchstart', () => {
          hoverTrigger.classList.add('hidden');
        });

        // Add visibility check on page load and after transitions
        const checkHoverTriggerVisibility = () => {
          const bottomSectionRect = bottomSection.getBoundingClientRect();
          const hoverTriggerRect = hoverTrigger.getBoundingClientRect();
          
          if (bottomSectionRect.top < window.innerHeight) {
            hoverTrigger.classList.add('hidden');
          } else {
            hoverTrigger.classList.remove('hidden');
          }
        };

        // Check visibility on page load
        checkHoverTriggerVisibility();

        // Check visibility after bottom section transitions
        bottomSection.addEventListener('transitionend', checkHoverTriggerVisibility);

        // Initialize panorama
        const panoDiv = document.getElementById('panorama');
        renderPanorama(layouts[currentLayoutIndex].panoramas[viewIndex], panoDiv);

        // Update layout options
        const layoutOptionsContainer = document.querySelector('.layout-options-container');
        layoutOptionsContainer.innerHTML = layouts[currentLayoutIndex].options.map((option, index) => {
          const choice = String.fromCharCode(65 + index); // Convert 0,1,2 to A,B,C
          return `
            <div class="layout-option">
              <img src="${option}" class="layout-img" data-choice="${choice}" />
              <div class="layout-label">${choice}</div>
            </div>
          `;
        }).join('');

        // Setup layout selection
        let selectedLayout = null;
        document.querySelectorAll(".layout-img").forEach(img => {
          img.addEventListener("click", function () {
            // Hide confirmation message if it's showing
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = "none";
            messageDiv.innerHTML = ''; // Clear the confidence container completely
            
            // Hide the "Please select a layout first" message
            const feedbackDiv = document.querySelector(".feedback-text");
            if (feedbackDiv.textContent === "Please select a layout first.") {
              feedbackDiv.textContent = "";
              feedbackDiv.className = "feedback-text";
            }
            
            document.querySelectorAll(".layout-img").forEach(i => {
              i.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedLayout = this.getAttribute("data-choice");
          });
        });

        // Add click handler for the right hover trigger
        const nextView = document.getElementById('nextViewBtn');
        nextView.addEventListener('click', function() {
          logAreaChange('New-View')
          // Check if the trigger has the complete class (added when progress is done)
          if (nextView.classList.contains('complete')) {
            // Hide confirmation message if it's showing
            document.getElementById('message').style.display = "none";
            
            if (viewIndex < layouts[currentLayoutIndex].panoramas.length - 1) {
              // Record duration of current view
              const viewDuration = (Date.now() - viewStartTime) / 1000; // Convert to seconds
              viewDurations.push(viewDuration);
              
              viewIndex++;
              viewsTaken++;
                
              // Clean up the previous panorama before rendering the new one
              const panoDiv = document.getElementById('panorama');
              if (panoDiv.cleanup) {
                panoDiv.cleanup();
              }
                
              renderPanorama(layouts[currentLayoutIndex].panoramas[viewIndex], panoDiv);
              updateMoneyDisplay();

              // Reset progress tracking for new view
              progressStartTime = Date.now();

              // Update the bonus amount in the bottom section
              const bonusAmount = document.querySelector('.bonus-amount');
              if (bonusAmount) {
                bonusAmount.textContent = (maxBonus - viewsTaken * viewCost).toFixed(2);
              }

              // Reset buttons to initial state
              const confirmBtn = document.getElementById('confirmBtn');
              if (confirmBtn) {
                confirmBtn.remove();
              }
              submitBtn.style.display = 'block';
              submitBtn.disabled = true;  // Keep submit button disabled until progress is complete
              const feedbackDiv = document.querySelector(".feedback-text");
              if (feedbackDiv) {
                feedbackDiv.textContent = "Please view the whole scene first.";
                feedbackDiv.className = "feedback-text feedback-incorrect";
              }

              // Deselect any selected layout and confidence options
              document.querySelectorAll(".layout-img").forEach(img => {
                img.classList.remove('selected');
              });
              document.querySelectorAll(".confidence-option").forEach(opt => {
                opt.classList.remove('selected');
              });
            
              // Start timing new view
              viewStartTime = Date.now();
            }
          }
        });

        // Add click handlers to layout images
        document.querySelectorAll(".layout-img").forEach(img => {
          img.addEventListener("click", function () {
            const choice = this.dataset.choice;
            logActionInArea(`${choice}`);
            // Hide confirmation message if it's showing
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = "none";
            messageDiv.innerHTML = ''; // Clear the confidence container completely
            
            // Hide the "Please select a layout first" message
            const feedbackDiv = document.querySelector(".feedback-text");
            if (feedbackDiv.textContent === "Please select a layout first.") {
              feedbackDiv.textContent = "";
              feedbackDiv.className = "feedback-text";
            }
            
            // Reset buttons to initial state
            const confirmBtn = document.getElementById('confirmBtn');
            if (confirmBtn) {
              confirmBtn.remove();
            }
            submitBtn.style.display = 'block';
            
            // Only enable submit button if progress is complete
            if (!document.getElementById('nextViewBtn').disabled) {
              submitBtn.disabled = false;
              if (feedbackDiv) {
                feedbackDiv.textContent = "";
                feedbackDiv.className = "feedback-text";
              }
            } else {
              submitBtn.disabled = true;
              if (feedbackDiv) {
                feedbackDiv.textContent = "Please view the whole scene first.";
                feedbackDiv.className = "feedback-text feedback-incorrect";
              }
            }

            // Reset confidence selection
            document.querySelectorAll(".confidence-option").forEach(opt => {
              opt.classList.remove('selected');
            });
            
            document.querySelectorAll(".layout-img").forEach(i => {
              i.classList.remove('selected');
            });
            this.classList.add('selected');
          });
        });

        // Modify Submit button handler
        document.getElementById('submitBtn').addEventListener('click', () => {
          logActionInArea(`submitBtn`);
          const selectedLayout = document.querySelector(".layout-img.selected")?.getAttribute("data-choice");
          const messageDiv = document.getElementById('message');
          const feedbackDiv = document.querySelector(".feedback-text");
          const currentLayout = layouts[currentLayoutIndex];
          
          if (!selectedLayout) {
            feedbackDiv.textContent = "Please select a layout first.";
            feedbackDiv.className = "feedback-text feedback-incorrect";
            return;
          }

          // Check if confidence is already selected
          const confidenceContainer = messageDiv.querySelector('.confidence-container');
          const selectedConfidence = messageDiv.querySelector('.confidence-option.selected')?.dataset.value;
          
          if (confidenceContainer && !selectedConfidence) {
            confidenceContainer.classList.add('shake');
            setTimeout(() => {
              confidenceContainer.classList.remove('shake');
            }, 500);
            return;
          }

          // Show confidence scale if not already shown
          if (!confidenceContainer) {
            messageDiv.innerHTML = `
              <div class="confidence-container">
                <p>How confident are you in your answer?</p>
                <div class="confidence-options">
                  <div class="confidence-option" data-value="1">
                    <div class="check-circle"></div>
                    <span class="option-text">Not confident at all <br>(0–20%)</span>
                  </div>
                  <div class="confidence-option" data-value="2">
                    <div class="check-circle"></div>
                    <span class="option-text">Slightly confident <br>(21–40%)</span>
                  </div>
                  <div class="confidence-option" data-value="3">
                    <div class="check-circle"></div>
                    <span class="option-text">Somewhat confident <br>(41–60%)</span>
                  </div>
                  <div class="confidence-option" data-value="4">
                    <div class="check-circle"></div>
                    <span class="option-text">Very confident <br>(61–80%)</span>
                  </div>
                  <div class="confidence-option" data-value="5">
                    <div class="check-circle"></div>
                    <span class="option-text">Completely confident <br>(81–100%)</span>
                  </div>
                </div>
              </div>
            `;
            messageDiv.className = "message-container";
            messageDiv.style.display = "block";

            // Add click handlers for confidence options
            const confidenceOptions = messageDiv.querySelectorAll('.confidence-option');
            const submitBtn = document.getElementById('submitBtn');
          
            confidenceOptions.forEach(option => {
              option.addEventListener('click', () => {
                logActionInArea(`${option.dataset.value}`);
                confidenceOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                
                // Hide submit button and show confirm button
                submitBtn.style.display = 'none';
                // Remove existing confirm button if it exists
                const existingConfirmBtn = document.getElementById('confirmBtn');
                if (existingConfirmBtn) {
                  existingConfirmBtn.remove();
                }
                const confirmBtn = document.createElement('button');
                confirmBtn.id = 'confirmBtn';
                confirmBtn.className = 'confirm-btn';
                confirmBtn.textContent = 'Confirm Submission';
                confirmBtn.style.margin = submitBtn.style.margin;  // Match margin only
                submitBtn.parentNode.insertBefore(confirmBtn, submitBtn.nextSibling);
                
                // Add click handler for confirm button
                confirmBtn.onclick = () => {
                  logActionInArea(`confirmBtn`);
                  // Hide confirm button and show next layout button
                  confirmBtn.style.display = 'none';
                  const nextLayoutBtn = document.getElementById('nextLayoutBtn');
                  nextLayoutBtn.style.display = 'block';
                  
                  // Disable the Next View button and right hover trigger when showing Next Layout button
                  document.getElementById('nextViewBtn').disabled = true;
                  document.getElementById('nextViewBtn').title = "Choice submitted - cannot view other scenes";
                  document.getElementById('nextViewBtn').style.pointerEvents = 'none';
                  document.getElementById('nextViewBtn').style.opacity = '0.5';
                  
                  // Fix the bottom section in place
                  document.querySelector('.bottom-section').classList.add('fixed');
                      
                  // Record duration of final view
                  const finalViewDuration = (Date.now() - viewStartTime) / 1000;
                  viewDurations.push(finalViewDuration);

                  // Record data for this layout
                  const layoutResult = {
                    participant_id: subject_id,
                    layoutIndex: currentLayoutIndex + 1,
                    startTimestamp: layoutStartTime,
                    endTimestamp: getTimestamp(),
                    viewCount: viewsTaken + 1,
                    // viewDurations: viewDurations,
                    viewDurations: viewDurations.join(';'),
                    progressCompletionTimes: progressCompletionTimes.join(';'), // Add this line
                    totalTimeSpent: viewDurations.reduce((a, b) => a + b, 0),
                    selectedChoice: selectedLayout,
                    correctChoice: currentLayout.correctAnswer,
                    isCorrect: selectedLayout === currentLayout.correctAnswer,
                    confidence: parseInt(option.dataset.value),
                    earnedBonus: selectedLayout === currentLayout.correctAnswer ? (currentLayout.maxBonus - viewsTaken * viewCost) : 0,
                  };
                  layoutData.push(layoutResult);

                  // Hide confirmation message
                  messageDiv.style.display = "none";
                  messageDiv.innerHTML = ''; // Clear the confidence container completely

                  // Hide the bonus message
                  const bonusMessage = document.querySelector('.potential-bonus-message');
                  if (bonusMessage) {
                    bonusMessage.style.display = 'none';
                  }

                  // Disable further selections
                  document.querySelectorAll(".layout-img").forEach(img => {
                    img.style.pointerEvents = "none";
                  });

                  const isCorrect = selectedLayout === currentLayout.correctAnswer;
                  const earnedBonus = isCorrect ? (currentLayout.maxBonus - viewsTaken * viewCost) : 0;
                  totalEarned += earnedBonus;

                  // Show feedback
                  if (isCorrect) {
                    feedbackDiv.innerHTML = `<span class="feedback-correct">Correct! Well done!</span><br><br><span>Your total earned money is €${totalEarned.toFixed(2)}</span>`;
                    feedbackDiv.className = "feedback-text";
                    document.querySelector(`.layout-img[data-choice="${selectedLayout}"]`).classList.add("correct");
                  } 
                  else {
                    feedbackDiv.innerHTML = `<span class="feedback-incorrect">Incorrect. The correct layout is ${currentLayout.correctAnswer}.</span><br><br><span>Your total earned money is €${totalEarned.toFixed(2)}</span>`;
                    feedbackDiv.className = "feedback-text";
                    document.querySelector(`.layout-img[data-choice="${selectedLayout}"]`).classList.add("incorrect");
                    document.querySelector(`.layout-img[data-choice="${currentLayout.correctAnswer}"]`).classList.add("correct");
                  }

                  // Update money display with zero potential bonus
                  const moneyDisplay = document.querySelector('.money-display');
                  moneyDisplay.innerHTML = `
                    <div class="money-item">
                      <span class="money-label">Earned Money: </span>
                      <span class="money-value">€${totalEarned.toFixed(2)}</span>
                    </div>
                    <div class="money-item">
                      <span class="money-label">Potential Bonus: </span>
                      <span class="money-value bonus-value">+€0.00</span>
                    </div>
                  `;

                  // Show next layout button if there are more layouts
                  if (currentLayoutIndex < layouts.length - 1) {
                    nextLayoutBtn.textContent = 'Next Layout';
                    nextLayoutBtn.onclick = () => {
                      logAreaChange('between-layouts');
                      currentLayoutIndex++;
                      viewIndex = 0;
                      viewsTaken = 0;
                          
                      // Clean up the previous panorama
                      const panoDiv = document.getElementById('panorama');
                      if (panoDiv.cleanup) {
                        panoDiv.cleanup();
                      }
                      
                      // Then log entry to new layout
                      logAreaChange(`layout-${currentLayoutIndex + 1}-start`);

                      // Reset the trial for the next layout
                      document.getElementById('submitBtn').style.display = 'block';
                      document.getElementById('submitBtn').disabled = false;
                      document.getElementById('nextViewBtn').disabled = true;
                      document.getElementById('nextViewBtn').title = "Please view the whole scene to proceed";
                      
                      // Restore the right hover trigger to normal state
                      const nextView = document.getElementById('nextViewBtn');
                      nextView.style.pointerEvents = 'auto';
                      nextView.style.opacity = '1';
                      nextView.classList.remove('complete');
                      
                      // Remove fixed class from bottom section to restore normal behavior
                      const bottomSection = document.querySelector('.bottom-section');
                      bottomSection.classList.remove('fixed');
                      bottomSection.style.transition = 'none';  // Disable transition temporarily
                      // bottomSection.style.bottom = '-100%';  // Force collapse
                      bottomSection.classList.remove('visible');
                          
                      // Reset the hover behavior after a short delay (after transition)
                      setTimeout(() => {
                          bottomSection.style.bottom = '';  // Remove inline style to restore CSS transitions
                          
                          bottomSection.style.transition = 'bottom 0.3s ease-in-out';  // Restore original transition

                          // Show and reset the hover trigger
                          const hoverTrigger = document.querySelector('.hover-trigger');
                          hoverTrigger.style.display = 'flex';
                          hoverTrigger.classList.remove('hidden');

                          // Re-add hover event listeners
                          hoverTrigger.addEventListener('mouseenter', () => {
                              // bottomSection.style.bottom = '0';
                              bottomSection.classList.add('visible');
                          });
                          
                          bottomSection.addEventListener('mouseleave', () => {
                              // bottomSection.style.bottom = '-100%';
                              bottomSection.classList.remove('visible');
                              logAreaChange(null); // Will log exit from bottom-section
                          });
                      }, 30);  // Delay matches the CSS transition time

                      document.querySelector(".feedback-text").textContent = "";
                      document.querySelectorAll(".layout-img").forEach(img => {
                        img.style.pointerEvents = "auto";
                        img.classList.remove("selected", "correct", "incorrect");
                      });
                      
                      // Update panorama and layout options for the new layout
                      renderPanorama(layouts[currentLayoutIndex].panoramas[0], document.getElementById('panorama'));
                      
                      // Update layout options for new layout
                      const layoutOptionsContainer = document.querySelector('.layout-options-container');
                      layoutOptionsContainer.innerHTML = layouts[currentLayoutIndex].options.map((option, index) => {
                        const choice = String.fromCharCode(65 + index); // Convert 0,1,2 to A,B,C
                        return `
                          <div class="layout-option">
                            <img src="${option}" class="layout-img" data-choice="${choice}" />
                            <div class="layout-label">${choice}</div>
                          </div>
                        `;
                      }).join('');
                      
                      // Show the bonus message again for the new layout
                      const bonusMessage = document.querySelector('.potential-bonus-message');
                      if (bonusMessage) {
                        bonusMessage.style.display = 'block';
                        // Update the bonus amount to match the current potential bonus
                        const bonusAmount = bonusMessage.querySelector('.bonus-amount');
                        if (bonusAmount) {
                          bonusAmount.textContent = (maxBonus - viewsTaken * viewCost).toFixed(2);
                        }
                      }
                      
                      // Re-attach click handlers to new layout images
                      document.querySelectorAll(".layout-img").forEach(img => {
                        img.addEventListener("click", function () {
                          const choice = this.dataset.choice;
                          logActionInArea(`${choice}`);
                          // Hide confirmation message if it's showing
                          const messageDiv = document.getElementById('message');
                          messageDiv.style.display = "none";
                          messageDiv.innerHTML = ''; // Clear the confidence container completely
                          
                          // Hide the "Please select a layout first" message
                          const feedbackDiv = document.querySelector(".feedback-text");
                          if (feedbackDiv.textContent === "Please select a layout first.") {
                            feedbackDiv.textContent = "";
                            feedbackDiv.className = "feedback-text";
                          }

                          // Reset buttons to initial state
                          const confirmBtn = document.getElementById('confirmBtn');
                          if (confirmBtn) {
                            confirmBtn.remove();
                          }
                          const submitBtn = document.getElementById('submitBtn');
                          submitBtn.style.display = 'block';
                              
                          document.querySelectorAll(".layout-img").forEach(i => {
                            i.classList.remove('selected');
                          });
                          this.classList.add('selected');
                        });
                      });
                      
                      // Update money display to show accumulated earnings and new potential bonus
                      updateMoneyDisplay();
                      
                      // Hide the next layout button
                      nextLayoutBtn.style.display = 'none';

                      // When moving to next layout or finishing, reset the timing variables
                      viewDurations = [];
                      progressCompletionTimes = [];
                      viewStartTime = Date.now();
                    };
                  }
                  else {
                    nextLayoutBtn.textContent = 'Finish Experiment';
                    nextLayoutBtn.onclick = () => {
                      // Log final transition
                      logAreaChange('experiment-end');

                      jsPsych.finishTrial();
                    };
                  };
                }
              });
            });
          };
        });
      },

      on_finish: function(data) {
        // Remove black background from body when trial ends
        document.body.classList.remove('black-background');
        // Add the layout data only to this trial's data
        data.totalEarned = totalEarned;
        data.layouts = layoutData;
      }
    };

    timeline.push(trial_combined);

    // After your last trial (after trial_combined), add the save data trial:
    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "WtGzR3nDrRcE",
      filename: filename,
      version: "1.0.0",
      data: {},
      token: "gc1AmocgNeKHTu0dqml6J0O2FilCbyCvuHaMEHQM9c19AZOXT0wFqTcTHuCKC3Ome7IBDf",
      data_string: () => jsPsych.data.get().csv()
    };

    // Add the save_data trial to your timeline (before the debrief block)
    timeline.push(save_data);  // Add this line to save the data

    const save_layout_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "WtGzR3nDrRcE",
      filename: `layouts_${filename}`,
      version: "1.0.0",
      data: {},
      token: "gc1AmocgNeKHTu0dqml6J0O2FilCbyCvuHaMEHQM9c19AZOXT0wFqTcTHuCKC3Ome7IBDf",
      data_string: () => {
        const headers = [
          "participant_id",
          "layoutIndex",
          "startTimestamp",
          "endTimestamp",
          "viewCount",
          "totalTimeSpent",
          "viewDurations",
          "progressCompletionTimes",
          "selectedChoice",
          "correctChoice",
          "isCorrect",
          "confidence",
          "earnedBonus"
        ].join(",");

        const rows = layoutData.map(layout => [
          layout.participant_id,
          layout.layoutIndex,
          layout.startTimestamp,
          layout.endTimestamp,
          layout.viewCount,
          layout.totalTimeSpent,
          layout.viewDurations,
          layout.progressCompletionTimes,
          layout.selectedChoice,
          layout.correctChoice,
          layout.isCorrect,
          layout.confidence,
          layout.earnedBonus
        ].join(","));

        console.log("Layout CSV:", [headers, ...rows].join("\n")); 
        return [headers, ...rows].join("\n");
      }
    };
    timeline.push(save_layout_data);

    const logAreaChange = (newArea) => {
      const now = Date.now();
      
      if (currentArea !== null) {
        // Record exit from previous area
        logData.push({
          participant_id: subject_id,
          layoutIndex: currentLayoutIndex + 1,
          view_index: viewIndex,
          event: currentArea,
          event_timestamp: new Date(areaStartTime).toISOString(),
          duration: (now - areaStartTime) / 1000,
          action_detail:  [...currentActionDetails]
        });
        currentActionDetails = [];
      }

      // Start new area
      currentArea = newArea;
      areaStartTime = now;
    };

    const logActionInArea = (actionDetail) => {
      if (currentArea !== null) {
      currentActionDetails.push(actionDetail);
    }
    };

    const save_log_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "WtGzR3nDrRcE",
      filename: `logs_${filename}`,
      version: "1.0.0",
      data: {},
      token: "gc1AmocgNeKHTu0dqml6J0O2FilCbyCvuHaMEHQM9c19AZOXT0wFqTcTHuCKC3Ome7IBDf",
      data_string: () => {
        const headers = [
          "participant_id",
          "layoutIndex",
          "view_index",
          "event",
          "event_timestamp",
          "duration",
          "action_detail"
        ].join(",");

        const rows = logData.map(entry => [
          entry.participant_id,
          entry.layoutIndex,
          entry.view_index,
          entry.event,
          entry.event_timestamp,
          entry.duration.toFixed(3),
          JSON.stringify(entry.action_detail)
        ].join(","));

        return [headers, ...rows].join("\n");
      }
    };

    // Add to timeline
    timeline.push(save_log_data);

    // Add a display trial to show the layout data
    const display_layout_data = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const headers = [
          "participant_id",
          "layoutIndex",
          "startTimestamp",
          "endTimestamp",
          "viewCount",
          "totalTimeSpent",
          "viewDurations",
          "progressCompletionTimes",
          "selectedChoice",
          "correctChoice",
          "isCorrect",
          "confidence",
          "earnedBonus"
        ];

        const rows = layoutData.map(layout => [
          layout.participant_id,
          layout.layoutIndex,
          layout.startTimestamp,
          layout.endTimestamp,
          layout.viewCount,
          layout.totalTimeSpent,
          layout.viewDurations,
          layout.progressCompletionTimes,
          layout.selectedChoice,
          layout.correctChoice,
          layout.isCorrect,
          layout.confidence,
          layout.earnedBonus
        ]);

        // Create a table-like display
        const tableHTML = `
          <div style="white-space: pre; text-align: left; font-family: monospace; padding: 20px; max-width: 1000px; margin: 0 auto; overflow-x: auto;">
            <h3>Layout Data:</h3>
            <table style="border-collapse: collapse; width: 100%;">
              <thead>
                <tr>
                  ${headers.map(h => `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${h}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${rows.map(row => `
                  <tr>
                    ${row.map(cell => `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <p style="margin-top: 20px;">Press any key to continue...</p>
          </div>
        `;

        return tableHTML;
      },
      choices: "ALL_KEYS"
    };
    // timeline.push(display_layout_data);

    const display_log_data = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const headers = [
          "participant_id",
          "layoutIndex",
          "view_index",
          "event",
          "event_timestamp",
          "duration",
          "action_detail"
        ];

        const rows = logData.map(entry => [
          entry.participant_id,
          entry.layoutIndex,
          entry.view_index,
          entry.event,
          entry.event_timestamp,
          entry.duration.toFixed(3),
          JSON.stringify(entry.action_detail)
        ]);

        // Create a table-like display
        const tableHTML = `
          <div style="white-space: pre; text-align: left; font-family: monospace; padding: 20px; max-width: 1000px; margin: 0 auto; overflow-x: auto;">
            <h3>Layout Data:</h3>
            <table style="border-collapse: collapse; width: 100%;">
              <thead>
                <tr>
                  ${headers.map(h => `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${h}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${rows.map(row => `
                  <tr>
                    ${row.map(cell => `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <p style="margin-top: 20px;">Press any key to continue...</p>
          </div>
        `;

        return tableHTML;
      },
      choices: "ALL_KEYS"
    };
    // timeline.push(display_log_data);

    const debrief_block = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function () {
        // Replace this with your actual Prolific completion URL
        const prolificURL = "https://app.prolific.co/submissions/complete?cc=XXXXXXX";
        
        return `
          <div class="welcome-message">
            <h2>Thank you!</h2>
            <p>Total earned: <strong>€${totalEarned.toFixed(2)}</strong></p>
            <p>You will be redirected back to Prolific in <span id="countdown">10</span> seconds.</p>
            <p style="margin-top: 20px; font-size: 0.9em;">
              If you are not redirected automatically, please click or copy this link:<br>
              <a href="${prolificURL}" style="color: #007bff; text-decoration: underline;">${prolificURL}</a>
            </p>
          </div>
        `;
      },
      on_load: function() {
        let timeLeft = 10;
        const countdownElement = document.getElementById('countdown');
        
        const countdown = setInterval(function() {
          timeLeft--;
          countdownElement.textContent = timeLeft;
          
          if (timeLeft <= 0) {
            clearInterval(countdown);
            window.location.href = "https://app.prolific.co/submissions/complete?cc=XXXXXXX";
          }
        }, 1000);
      },
      choices: "NO_KEYS"
    };
    // timeline.push(debrief_block);


    /* start the experiment */
    jsPsych.run(timeline);

  </script>
</body>
</html>
